# syntax=docker/dockerfile:1.4
# Debug version of Dockerfile.gpu-factory
# This version provides verbose output for monitoring install progress
#
# Usage:
#   docker build --progress=plain -f Dockerfile.gpu-factory.debug -t infinilm-svc:debug .
# Note: BuildKit cache mounts removed for compatibility with Docker versions that don't support BuildKit
# To enable cache mounts, set DOCKER_BUILDKIT=1 before building

ARG BASE_IMAGE=cr.metax-tech.com/public-ai-release-wb/x201/vllm:hpcc2.32.0.11-torch2.4-py310-kylin2309a-arm64
# Proxy settings (optional, can be set via --build-arg)
ARG HTTP_PROXY=""
ARG HTTPS_PROXY=""
ARG http_proxy=""
ARG https_proxy=""
ARG ALL_PROXY=""
ARG all_proxy=""
ARG NO_PROXY=""
ARG no_proxy=""

FROM ${BASE_IMAGE}

WORKDIR /app

# Set proxy environment variables if provided
ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
ENV http_proxy=${http_proxy}
ENV https_proxy=${https_proxy}
ENV ALL_PROXY=${ALL_PROXY}
ENV all_proxy=${all_proxy}
ENV NO_PROXY=${NO_PROXY}
ENV no_proxy=${no_proxy}

# Copy all project files
COPY . .

# Set deployment case environment variable
ENV DEPLOYMENT_CASE=infinilm-metax-deployment

# Enable verbose output
ENV DEBUG=1
ENV VERBOSE=1

# Use the base conda environment from the base image directly
# Ensure conda bin is first in PATH so git and other tools from conda are used
ENV PATH="/opt/conda/bin:/usr/bin:/usr/local/bin:${PATH}"

# Run install script with explicit output (no redirection)
# Split into steps for better visibility
RUN echo "==========================================" && \
    echo "Starting InfiniLM-SVC Installation" && \
    echo "==========================================" && \
    echo "Deployment case: ${DEPLOYMENT_CASE}" && \
    echo "Install path: /usr/local/bin" && \
    echo ""

# Check if git is available in base conda environment (use conda bin directly)
RUN echo "[Step 0/6] Checking for git in base conda environment..." && \
    if [ -x /opt/conda/bin/git ]; then \
        echo "✓ git found in base conda environment at /opt/conda/bin/git"; \
        /opt/conda/bin/git --version || true; \
    elif command -v git >/dev/null 2>&1; then \
        echo "✓ git found at $(command -v git)"; \
        git --version || true; \
    else \
        echo "⚠ git not found in base conda environment, install.sh will attempt installation"; \
    fi && \
    echo "[Step 0/6] ✓ Git check completed"

RUN echo "[Step 1/6] Running install.sh..." && \
    mkdir -p /workspace && \
    ./scripts/install.sh \
        --install-path /usr/local/bin \
        --deployment-case infinilm-metax-deployment \
        --install-infinicore true \
        --install-infinilm true \
        --infinicore-src /workspace/InfiniCore \
        --infinilm-src /workspace/InfiniLM && \
    echo "[Step 1/6] ✓ Install script completed"

RUN echo "[Step 2/6] Verifying binaries..." && \
    which infini-registry && \
    which infini-router && \
    which infini-babysitter && \
    echo "[Step 2/6] ✓ All binaries found"

RUN echo "[Step 3/6] Testing binaries..." && \
    (infini-registry --help 2>&1 || true) && \
    (infini-router --help 2>&1 || true) && \
    (infini-babysitter --help 2>&1 || true) && \
    echo "[Step 3/6] ✓ Binary tests completed (warnings may appear due to missing runtime libs)"

RUN echo "[Step 4/6] Copying deployment case files..." && \
    cp deployment/cases/infinilm-metax-deployment/embeddings_server.py ./embeddings_server.py && \
    cp deployment/cases/infinilm-metax-deployment/env-set.sh ./env-set.sh 2>/dev/null || true && \
    cp deployment/cases/infinilm-metax-deployment/requirements-embeddings.txt ./requirements-embeddings.txt 2>/dev/null || true && \
    echo "[Step 4/6] ✓ Deployment files copied"

RUN echo "[Step 5/6] Setting up scripts..." && \
    cp docker/docker_entrypoint_rust.sh ./docker_entrypoint.sh && \
    chmod +x ./script/*.sh ./docker_entrypoint.sh 2>/dev/null || true && \
    echo "[Step 5/6] ✓ Scripts set up"

RUN echo "[Step 6/6] Creating directories..." && \
    mkdir -p logs config /workspace/models && \
    echo "[Step 6/6] ✓ Directories created" && \
    echo "" && \
    echo "==========================================" && \
    echo "Build completed successfully!" && \
    echo "=========================================="

# Unset proxy environment variables at the end of build to avoid proxy interference at runtime
# Proxy is only needed during build for downloading dependencies
# At runtime, services should connect directly without proxy routing issues
# Set NO_PROXY to include localhost/127.0.0.1 to ensure local connections bypass proxy
ENV HTTP_PROXY=""
ENV HTTPS_PROXY=""
ENV http_proxy=""
ENV https_proxy=""
ENV ALL_PROXY=""
ENV all_proxy=""
ENV NO_PROXY="localhost,127.0.0.1,0.0.0.0"
ENV no_proxy="localhost,127.0.0.1,0.0.0.0"

WORKDIR /app

ENTRYPOINT ["/bin/bash", "/app/docker_entrypoint.sh"]

EXPOSE 18000 8000 20002

LABEL maintainer="InfiniLM Team"
LABEL description="InfiniLM-SVC: Debug build with verbose output"
LABEL deployment-case="infinilm-metax-deployment"
LABEL base-image="${BASE_IMAGE}"
