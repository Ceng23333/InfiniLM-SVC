# syntax=docker/dockerfile:1.4
# Debug version of Dockerfile.gpu-factory
# This version provides verbose output for monitoring install progress
#
# Usage:
#   docker build --progress=plain -f Dockerfile.gpu-factory.debug -t infinilm-svc:debug .
# Note: BuildKit cache mounts removed for compatibility with Docker versions that don't support BuildKit
# To enable cache mounts, set DOCKER_BUILDKIT=1 before building

ARG BASE_IMAGE=cr.metax-tech.com/public-ai-release-wb/x201/vllm:hpcc2.32.0.11-torch2.4-py310-kylin2309a-arm64
# Proxy settings (optional, can be set via --build-arg)
ARG HTTP_PROXY=""
ARG HTTPS_PROXY=""
ARG http_proxy=""
ARG https_proxy=""
ARG ALL_PROXY=""
ARG all_proxy=""
ARG NO_PROXY=""
ARG no_proxy=""

FROM ${BASE_IMAGE}

WORKDIR /app

# Set proxy environment variables if provided
ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
ENV http_proxy=${http_proxy}
ENV https_proxy=${https_proxy}
ENV ALL_PROXY=${ALL_PROXY}
ENV all_proxy=${all_proxy}
ENV NO_PROXY=${NO_PROXY}
ENV no_proxy=${no_proxy}

# Copy all project files
COPY . .

# Set deployment case environment variable
ENV DEPLOYMENT_CASE=infinilm-metax-deployment

# Enable verbose output
ENV DEBUG=1
ENV VERBOSE=1

# Install git first (required for cloning InfiniCore/InfiniLM)
# Try multiple methods: check existing, conda, yum/dnf, apt-get
# Ensure common git locations are in PATH
ENV PATH="/usr/bin:/usr/local/bin:/opt/conda/bin:${PATH}"

# Configure git and conda to use proxy if set
RUN echo "[Pre-install] Configuring proxy for git/conda..." && \
    ([ -z "${HTTP_PROXY}" ] && [ -z "${HTTPS_PROXY}" ] && echo "No proxy configured" || \
     (([ -n "${HTTP_PROXY}" ] && git config --global http.proxy "${HTTP_PROXY}" 2>/dev/null || true) && \
      ([ -n "${HTTPS_PROXY}" ] && git config --global https.proxy "${HTTPS_PROXY}" 2>/dev/null || true) && \
      echo "✓ Proxy configured for git")) && \
    echo "[Pre-install] Installing git..." && \
    (command -v git >/dev/null 2>&1 && echo "✓ git already available" || \
     ([ -f /usr/bin/git ] || [ -f /usr/local/bin/git ] || [ -f /opt/conda/bin/git ]) && echo "✓ git found in common locations" || \
     (command -v conda >/dev/null 2>&1 && \
      ([ -n "${HTTP_PROXY}" ] && export http_proxy="${HTTP_PROXY}" || true) && \
      ([ -n "${HTTPS_PROXY}" ] && export https_proxy="${HTTPS_PROXY}" || true) && \
      conda install -y git -c conda-forge >/dev/null 2>&1 && echo "✓ git installed via conda" || \
      (yum install -y git >/dev/null 2>&1 || dnf install -y git >/dev/null 2>&1 || apt-get update -qq >/dev/null 2>&1 && apt-get install -y git >/dev/null 2>&1 || true))) && \
    (command -v git >/dev/null 2>&1 && git --version || \
     ([ -f /usr/bin/git ] && /usr/bin/git --version) || \
     ([ -f /usr/local/bin/git ] && /usr/local/bin/git --version) || \
     ([ -f /opt/conda/bin/git ] && /opt/conda/bin/git --version)) && \
    echo "[Pre-install] ✓ git installation verified"

# Run install script with explicit output (no redirection)
# Split into steps for better visibility
RUN echo "==========================================" && \
    echo "Starting InfiniLM-SVC Installation" && \
    echo "==========================================" && \
    echo "Deployment case: ${DEPLOYMENT_CASE}" && \
    echo "Install path: /usr/local/bin" && \
    echo ""

RUN echo "[Step 1/6] Running install.sh..." && \
    mkdir -p /workspace && \
    ./scripts/install.sh \
        --install-path /usr/local/bin \
        --deployment-case infinilm-metax-deployment \
        --install-infinicore true \
        --install-infinilm true \
        --infinicore-src /workspace/InfiniCore \
        --infinilm-src /workspace/InfiniLM && \
    echo "[Step 1/6] ✓ Install script completed"

RUN echo "[Step 2/6] Verifying binaries..." && \
    which infini-registry && \
    which infini-router && \
    which infini-babysitter && \
    echo "[Step 2/6] ✓ All binaries found"

RUN echo "[Step 3/6] Testing binaries..." && \
    (infini-registry --help 2>&1 || true) && \
    (infini-router --help 2>&1 || true) && \
    (infini-babysitter --help 2>&1 || true) && \
    echo "[Step 3/6] ✓ Binary tests completed (warnings may appear due to missing runtime libs)"

RUN echo "[Step 4/6] Copying deployment case files..." && \
    cp deployment/cases/infinilm-metax-deployment/embeddings_server.py ./embeddings_server.py && \
    cp deployment/cases/infinilm-metax-deployment/env-set.sh ./env-set.sh 2>/dev/null || true && \
    cp deployment/cases/infinilm-metax-deployment/requirements-embeddings.txt ./requirements-embeddings.txt 2>/dev/null || true && \
    echo "[Step 4/6] ✓ Deployment files copied"

RUN echo "[Step 5/6] Setting up scripts..." && \
    cp docker/docker_entrypoint_rust.sh ./docker_entrypoint.sh && \
    chmod +x ./script/*.sh ./docker_entrypoint.sh 2>/dev/null || true && \
    echo "[Step 5/6] ✓ Scripts set up"

RUN echo "[Step 6/6] Creating directories..." && \
    mkdir -p logs config /workspace/models && \
    echo "[Step 6/6] ✓ Directories created" && \
    echo "" && \
    echo "==========================================" && \
    echo "Build completed successfully!" && \
    echo "=========================================="

WORKDIR /app

ENTRYPOINT ["/bin/bash", "/app/docker_entrypoint.sh"]

EXPOSE 18000 8000 20002

LABEL maintainer="InfiniLM Team"
LABEL description="InfiniLM-SVC: Debug build with verbose output"
LABEL deployment-case="infinilm-metax-deployment"
LABEL base-image="${BASE_IMAGE}"
